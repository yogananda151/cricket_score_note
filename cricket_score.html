<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cricket Score Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Tailwind CSS not used, using custom styles */
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --accent: #4cc9f0;
      --danger: #f72585;
      --success: #4caf50;
      --warning: #f8961e;
      --dark: #232365;
      --light: #f8f9fa;

      --bg-dark: #1a1a2e;
      --bg-glass: rgba(255, 255, 255, 0.1);
      --text-light: #ffffff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: white;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-attachment: fixed;
    }

    header {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      padding: 20px 40px;
      font-size: 2.5rem;
      text-align: center;
      color: var(--light);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 
                  0 0 0 5px rgba(67, 97, 238, 0.2),
                  0 0 0 10px rgba(67, 97, 238, 0.1);
      margin-bottom: 30px;
      transform-style: preserve-3d;
      transform: perspective(500px) rotateX(5deg);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) rotate(30deg); }
      100% { transform: translateX(100%) rotate(30deg); }
    }

    .container {
      width: 100%;
      max-width: 1100px;
      background: rgba(26, 26, 46, 0.8);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5),
                  inset 0 0 20px rgba(76, 201, 240, 0.1);
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(76, 201, 240, 0.2);
    }

    .teams {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .teams input {
      padding: 15px 20px;
      font-size: 1.1rem;
      width: 300px;
      border-radius: 12px;
      border: 2px solid var(--accent);
      background: rgba(26, 26, 46, 0.8);
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .teams input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.3);
      outline: none;
    }

    .scoreboard p, .targetboard p {
      font-size: 1.4rem;
      margin: 15px 0;
      color: white;
      font-weight: bold;
    }
    
    /* Scoreboard Animation */
    .scoreboard .score-value {
        display: inline-block;
        transition: transform 0.1s ease-out, color 0.1s ease-out;
    }
    .scoreboard .score-value.flash {
        transform: scale(1.1);
        color: var(--warning);
    }

    .scoreboard {
      background: linear-gradient(135deg, rgba(67, 97, 238, 0.3), rgba(63, 55, 201, 0.3));
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(76, 201, 240, 0.3);
      position: relative;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(6, 1fr); /* Changed to 6 columns */
      gap: 15px;
      margin-top: 30px;
    }

    .controls button {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 20px;
      font-size: 1rem; 
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }

    .controls button:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    .controls button:disabled {
      background: linear-gradient(135deg, #6c757d, #495057);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.5;
    }
    
    /* Dedicated Undo Button Style */
    #undoBtn {
        grid-column: span 2;
        background: linear-gradient(135deg, #ffc107, #e0a800) !important;
        color: #333 !important;
        font-weight: bold;
        font-size: 1.1rem;
    }
    #undoBtn:disabled {
        background: linear-gradient(135deg, #6c757d, #495057) !important;
    }

    /* Gradient overrides for specific buttons */
    .controls #run0Btn { background: linear-gradient(135deg, #6c757d, #495057); }
    .controls #run1Btn { background: linear-gradient(135deg, #4caf50, #2e7d32); }
    .controls #run2Btn { background: linear-gradient(135deg, #2196f3, #0d47a1); }
    .controls #run3Btn { background: linear-gradient(135deg, #00bcd4, #00838f); }
    .controls #run4Btn { background: linear-gradient(135deg, #ff9800, #e65100); }
    .controls #run6Btn { background: linear-gradient(135deg, #f44336, #b71c1c); }
    .controls #noballBtn { background: linear-gradient(135deg, #9c27b0, #6a1b9a); }
    .controls #wideBtn { background: linear-gradient(135deg, #ffeb3b, #fbc02d); color: #333; }
    .controls #wicketBtn { background: linear-gradient(135deg, #e91e63, #ad1457); }
    .controls #runWicketBtn { background: linear-gradient(135deg, #795548, #4e342e); }
    .controls #inningsBtn { 
        grid-column: span 3;
        background: linear-gradient(135deg, #8bc34a, #689f38); 
    }
    .controls #resetBtn { 
        grid-column: span 3;
        background: linear-gradient(135deg, #607d8b, #37474f); 
    }

    .targetboard {
      display: none;
      background: linear-gradient(135deg, rgba(247, 37, 133, 0.3), rgba(181, 23, 158, 0.3));
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(247, 37, 133, 0.3);
      margin-bottom: 30px;
    }

    /* Floating Animation with Bounce */
    .float-anim {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(1);
      font-size: 4rem;
      font-weight: bold;
      color: #ffea00;
      text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
      z-index: 999;
      animation: floatUp 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; /* Added bounce */
      pointer-events: none;
      filter: drop-shadow(0 0 10px currentColor);
    }

    @keyframes floatUp {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(0.8) rotate(0deg); }
      50% { opacity: 1; transform: translate(-50%, -60%) scale(1.1) rotate(5deg); }
      100% { opacity: 0; transform: translate(-50%, -150%) scale(1.5) rotate(10deg); }
    }

    .innings-status, #status {
      font-size: 1.2rem;
      color: var(--accent);
      margin-top: 20px;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(76, 201, 240, 0.5);
    }

    .overs-selector {
      margin: 30px 0;
    }

    .overs-selector input {
      font-size: 1.1rem;
      padding: 12px 20px;
      width: 200px;
      border-radius: 12px;
      background: rgba(26, 26, 46, 0.8);
      color: white;
      border: 2px solid var(--accent);
      text-align: center;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1001;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid var(--accent);
      text-align: center;
    }

    .modal h3 {
      margin-bottom: 20px;
      color: var(--accent);
    }

    .modal-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 20px;
    }

    .modal-buttons button {
      padding: 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #4caf50, #2e7d32);
      color: white;
    }

    .modal-buttons button:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
    }

    /* Over Summary Styles */
    .over-summary {
      background: rgba(26, 26, 46, 0.8);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      border: 1px solid var(--accent);
    }

    .summary-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .over-box {
      background: linear-gradient(135deg, rgba(67, 97, 238, 0.2), rgba(63, 55, 201, 0.2));
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 10px;
      min-width: 120px;
      text-align: left;
      transition: all 0.3s ease;
    }
    
    .over-box:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }

    .over-box.current-over {
      background: linear-gradient(135deg, rgba(76, 201, 240, 0.2), rgba(67, 97, 238, 0.2));
      border: 2px solid var(--accent);
      box-shadow: 0 0 10px rgba(76, 201, 240, 0.3);
      order: -1; 
    }

    .over-box .over-number {
      color: var(--accent);
      font-weight: bold;
      margin-bottom: 5px;
    }

    .over-box .balls {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .ball {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px; /* Slightly larger */
      height: 30px;
      border-radius: 50%;
      font-size: 0.9rem; /* Slightly larger font */
      font-weight: bold;
      color: white;
      background: rgba(76, 201, 240, 0.4);
      transition: transform 0.2s ease;
    }
    
    .ball:hover {
        transform: scale(1.1);
    }

    .ball.wide-ball {
      background: var(--warning);
      color: #333;
      border: 1px solid #333;
    }

    .ball.noball {
      background: var(--danger);
      border: 1px solid white;
    }

    .ball.wicket {
      background: #000;
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .ball.wicket-run {
      background: var(--dark);
      color: var(--danger);
      border: 1px solid var(--danger);
    }

    .over-box .total {
      margin-top: 5px;
      color: var(--success);
      font-weight: bold;
    }

    /* Media Queries */
    @media (max-width: 1000px) {
      .controls { 
          grid-template-columns: repeat(4, 1fr); 
      }
      #undoBtn {
          grid-column: span 2;
      }
      .controls #inningsBtn, .controls #resetBtn {
          grid-column: span 2;
      }
    }
    @media (max-width: 600px) {
      .controls { 
          grid-template-columns: repeat(3, 1fr); 
      }
      #undoBtn {
          grid-column: span 3;
      }
      .controls #inningsBtn, .controls #resetBtn {
          grid-column: span 3;
      }
    }
    @media (max-width: 480px) {
      .controls button { padding: 15px; font-size: 0.9rem; }
    }

  </style>
</head>
<body>

<header>üèè Cricket Score Tracker</header>

<div class="container">
  <div class="teams">
    <input type="text" id="team1" placeholder="Enter Team 1 Name" oninput="updateTeams()">
    <input type="text" id="team2" placeholder="Enter Team 2 Name" oninput="updateTeams()">
  </div>

  <div class="overs-selector">
    <label for="oversInput">Enter Number of Overs:</label>
    <input type="number" id="oversInput" placeholder="Enter Overs" min="1" oninput="updateOvers()" value="20" />
  </div>

  <div class="match-info">
    <h2 id="matchTitle">Team 1 vs Team 2</h2>
    <p class="innings-status" id="inningsDisplay">Innings: 1st - Batting: Team 1</p>
  </div>

  <div class="scoreboard">
    <p><strong>Score:</strong> <span id="runs" class="score-value">0</span>/<span id="wickets" class="score-value">0</span></p>
    <p><strong>Overs:</strong> <span id="overs" class="score-value">0</span>.<span id="balls" class="score-value">0</span></p>
    <p id="status"></p>
  </div>

  <div class="targetboard" id="targetBox">
    <p><strong>Target:</strong> <span id="targetDisplay">0</span></p>
    <p><strong>Required Runs:</strong> <span id="requiredRuns">0</span></p>
    <p><strong>Balls Remaining:</strong> <span id="ballsLeft">120</span></p>
  </div>

  <div class="over-summary">
    <h3>Over-by-Over Summary</h3>
    <div id="overSummary" class="summary-container"></div>
  </div>
  
  <div class="controls">
    <button onclick="addRun(0)" id="run0Btn">0</button>
    <button onclick="addRun(1)" id="run1Btn">1</button>
    <button onclick="addRun(2)" id="run2Btn">2</button>
    <button onclick="addRun(3)" id="run3Btn">3</button>
    <button onclick="addRun(4)" id="run4Btn">4</button>
    <button onclick="addRun(6)" id="run6Btn">6</button>
    <button onclick="showModal('noBallModal')" id="noballBtn">No Ball</button>
    <button onclick="wideBall()" id="wideBtn">Wide</button>
    <button onclick="addWicket()" id="wicketBtn">Wicket</button>
    <button onclick="showModal('runWicketModal')" id="runWicketBtn">Run & Wicket</button>
    <button onclick="undo()" id="undoBtn" disabled>Undo Last Action</button>
    <button onclick="switchInnings()" id="inningsBtn" disabled>Start 2nd Innings</button>
    <button onclick="reset()" id="resetBtn">Reset</button>
  </div>
</div>

<!-- No Ball Runs Modal -->
<div class="modal" id="noBallModal">
  <div class="modal-content">
    <h3>Runs scored off No Ball?</h3>
    <p>Select runs scored *in addition* to the 1 run for the No Ball:</p>
    <div class="modal-buttons">
      <button onclick="addNoBallRuns(0)">0 (Only 1nb)</button>
      <button onclick="addNoBallRuns(1)">1</button>
      <button onclick="addNoBallRuns(2)">2</button>
      <button onclick="addNoBallRuns(3)">3</button>
      <button onclick="addNoBallRuns(4)">4</button>
      <button onclick="addNoBallRuns(6)">6</button>
    </div>
  </div>
</div>

<!-- Run and Wicket Modal -->
<div class="modal" id="runWicketModal">
  <div class="modal-content">
    <h3>Run Out? Runs scored before Wicket?</h3>
    <p>Select runs scored on the delivery that resulted in the Wicket:</p>
    <div class="modal-buttons">
      <button onclick="addRunAndWicket(0)">0 (Just Wicket)</button>
      <button onclick="addRunAndWicket(1)">1</button>
      <button onclick="addRunAndWicket(2)">2</button>
      <button onclick="addRunAndWicket(3)">3</button>
      <button onclick="addRunAndWicket(4)">4</button>
      <button onclick="addRunAndWicket(6)">6</button>
    </div>
  </div>
</div>

<script>
  let runs = 0, wickets = 0, overs = 0, balls = 0;
  let totalBalls = 120;
  let target = 0;
  let firstInningsRuns = 0;
  let isSecondInnings = false;
  let currentOverBalls = [];
  let overHistory = [];
  
  // Undo/History variables
  let history = []; 

  // --- Utility Functions ---

  function saveState() {
    // Only save if the match is not yet decided or 1st innings isn't over (prevents saving final state before switch)
    const statusText = document.getElementById("status").textContent;
    if (statusText.includes("won") || statusText.includes("Tied") || statusText.includes("1st Innings Over")) {
        return;
    }
    
    // Save a deep copy of the current state
    history.push({
      runs, wickets, overs, balls,
      currentOverBalls: JSON.parse(JSON.stringify(currentOverBalls)),
      overHistory: JSON.parse(JSON.stringify(overHistory))
    });
    
    // Limit history size to prevent memory overload (e.g., last 20 actions)
    if (history.length > 20) {
        history.shift(); 
    }
    
    // Enable undo button if history is available
    document.getElementById('undoBtn').disabled = history.length <= 0;
  }

  function restoreState(state) {
    runs = state.runs;
    wickets = state.wickets;
    overs = state.overs;
    balls = state.balls;
    currentOverBalls = state.currentOverBalls;
    overHistory = state.overHistory;
  }
  
  function flashScoreboard() {
      const runsEl = document.getElementById('runs');
      const wicketsEl = document.getElementById('wickets');
      const oversEl = document.getElementById('overs');
      const ballsEl = document.getElementById('balls');
      
      [runsEl, wicketsEl, oversEl, ballsEl].forEach(el => {
          el.classList.add('flash');
          setTimeout(() => el.classList.remove('flash'), 200);
      });
  }

  // --- UI Update Functions ---
  
  function updateTeams() {
    const t1 = document.getElementById("team1").value || "Team 1";
    const t2 = document.getElementById("team2").value || "Team 2";
    document.getElementById("matchTitle").textContent = `${t1} vs ${t2}`;
    document.getElementById("inningsDisplay").textContent = `Innings: ${isSecondInnings ? "2nd" : "1st"} - Batting: ${isSecondInnings ? t2 : t1}`;
  }

  function updateOvers() {
    const oversInput = document.getElementById("oversInput").value;
    const newOvers = parseInt(oversInput);
    if (newOvers > 0 && newOvers * 6 !== totalBalls) {
      totalBalls = newOvers * 6;
      reset(); // Reset game state on change of total overs
      updateDisplay();
    }
  }

  function updateDisplay(scoreChanged = true) {
    document.getElementById('runs').textContent = runs;
    document.getElementById('wickets').textContent = wickets;
    document.getElementById('overs').textContent = overs;
    document.getElementById('balls').textContent = balls;
    
    if (scoreChanged) {
        flashScoreboard();
    }
    
    // Update undo button state
    document.getElementById('undoBtn').disabled = history.length === 0;

    const ballsBowled = overs * 6 + balls;
    const ballsRemaining = totalBalls - ballsBowled;

    if (isSecondInnings) {
      document.getElementById("targetBox").style.display = "block";
      document.getElementById('targetDisplay').textContent = target;
      document.getElementById('requiredRuns').textContent = Math.max(target - runs, 0);
      document.getElementById('ballsLeft').textContent = ballsRemaining;
    } else {
      document.getElementById("targetBox").style.display = "none";
    }

    updateTeams();
    displayOverSummary(); 
    checkMatchStatus(ballsRemaining);
  }

  function showFloatingEffect(text, emoji = "") {
    const el = document.createElement("div");
    el.className = "float-anim";
    el.innerHTML = `${emoji} ${text}`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1200); // Shorter duration to match animation
  }

  function showModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
  }

  function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
  }

  function setControlsDisabled(state) {
    const buttons = document.querySelectorAll('.controls button:not(#inningsBtn):not(#resetBtn):not(#undoBtn)');
    buttons.forEach(button => {
      button.disabled = state;
    });
  }

  // --- Score Logic Functions ---

  function incrementBall() {
    balls += 1;
    
    if (balls === 6) {
      if (currentOverBalls.length > 0) {
        let total = currentOverBalls.reduce((sum, ball) => sum + ball.runs, 0);
        overHistory.unshift({ 
          over: overs + 1,
          balls: [...currentOverBalls],
          total: total
        });
      }
      
      currentOverBalls = []; 
      balls = 0;
      overs += 1;
    }
    updateDisplay();
  }

  function updateOverSummary(run, type = 'normal') {
    let displayText = run.toString();
    let ballClass = '';
    
    // Determine display and class based on type
    if (type === 'wide') {
      displayText = `Wd${run > 1 ? run - 1 : ''}`;
      ballClass = 'wide-ball';
    } else if (type === 'noball') {
      displayText = `Nb${run > 1 ? run - 1 : ''}`;
      ballClass = 'noball';
    } else if (type === 'wicket') {
      displayText = 'W';
      ballClass = 'wicket';
    } else if (type === 'run_wicket') {
      displayText = `${run}W`;
      ballClass = 'wicket-run';
    } else if (run === 0) {
        displayText = '‚Ä¢';
        ballClass = 'dot-ball';
    }

    currentOverBalls.push({
      runs: run,
      type: ballClass,
      display: displayText
    });
  }

  function displayOverSummary() {
    const summaryContainer = document.getElementById('overSummary');
    summaryContainer.innerHTML = '';
    
    // Display current over box
    if (currentOverBalls.length > 0) {
      const currentOverBox = document.createElement('div');
      currentOverBox.className = 'over-box current-over';
      
      const overNumber = document.createElement('div');
      overNumber.className = 'over-number';
      overNumber.textContent = `Over ${overs + 1} (${balls} Balls)`;
      
      const ballsDiv = document.createElement('div');
      ballsDiv.className = 'balls';
      
      let overTotal = 0;
      currentOverBalls.forEach(ball => {
        const ballSpan = document.createElement('span');
        ballSpan.className = `ball ${ball.type}`;
        ballSpan.textContent = ball.display;
        ballsDiv.appendChild(ballSpan);
        overTotal += ball.runs;
      });
      
      const total = document.createElement('div');
      total.className = 'total';
      total.textContent = `Total: ${overTotal}`;
      
      currentOverBox.appendChild(overNumber);
      currentOverBox.appendChild(ballsDiv);
      currentOverBox.appendChild(total);
      summaryContainer.appendChild(currentOverBox);
    }
    
    // Display completed overs
    overHistory.forEach(over => {
      const overBox = document.createElement('div');
      overBox.className = 'over-box';
      
      const overNumber = document.createElement('div');
      overNumber.className = 'over-number';
      overNumber.textContent = `Over ${over.over}`;
      
      const ballsDiv = document.createElement('div');
      ballsDiv.className = 'balls';
      
      over.balls.forEach(ball => {
        const ballSpan = document.createElement('span');
        ballSpan.className = `ball ${ball.type}`;
        ballSpan.textContent = ball.display;
        ballsDiv.appendChild(ballSpan);
      });
      
      const total = document.createElement('div');
      total.className = 'total';
      total.textContent = `Total: ${over.total}`;
      
      overBox.appendChild(overNumber);
      overBox.appendChild(ballsDiv);
      overBox.appendChild(total);
      summaryContainer.appendChild(overBox);
    });
  }

  function addRun(run) {
    if (isMatchOver()) return;
    saveState(); // Save state before action
    
    runs += run;
    updateOverSummary(run, 'normal');
    incrementBall(); 
    
    let emoji = "‚ö°";
    if (run === 6) emoji = "üí•";
    else if (run === 4) emoji = "üî•";
    showFloatingEffect(`${run}`, emoji);
  }

  function wideBall() {
    if (isMatchOver()) return;
    saveState(); // Save state before action
    
    runs += 1; 
    showFloatingEffect("Wide + 1", "‚ö™");
    updateOverSummary(1, 'wide'); 
    updateDisplay();
  }

  function addNoBallRuns(extraRuns) {
    closeModal('noBallModal');
    if (isMatchOver()) return;
    saveState(); // Save state before action

    runs += 1 + extraRuns; 
    showFloatingEffect(`No Ball + ${extraRuns}`, "üü°");
    updateOverSummary(1 + extraRuns, 'noball'); 
    updateDisplay();
  }

  function addWicket() {
    if (isMatchOver()) return;
    if (wickets < 10) {
      saveState(); // Save state before action
      wickets += 1;
      updateOverSummary(0, 'wicket'); 
      incrementBall(); 
      showFloatingEffect("WICKET!", "üí£");
    }
  }

  function addRunAndWicket(run) {
    closeModal('runWicketModal');
    if (isMatchOver()) return;
    if (wickets < 10) {
      saveState(); // Save state before action
      runs += run;
      wickets += 1;
      updateOverSummary(run, 'run_wicket'); 
      incrementBall(); 
      showFloatingEffect(`${run} & WICKET!`, "‚ö°üí•");
    }
  }

  // --- Undo Function ---
  function undo() {
    if (history.length === 0) return;
    
    // 1. Get the previous state
    const previousState = history.pop();
    
    // 2. Restore the state variables
    restoreState(previousState);
    
    // 3. Update the display and controls
    document.getElementById('undoBtn').disabled = history.length === 0;
    
    // Reset status if match was just finished via the undo action
    if (isMatchOver()) {
        document.getElementById("status").textContent = "";
        setControlsDisabled(false);
    }
    
    showFloatingEffect("Undo", "‚Ü©Ô∏è");
    updateDisplay();
  }

  // --- Match Flow Functions ---

  function isMatchOver() {
    return document.getElementById("status").textContent.includes("won") || document.getElementById("status").textContent.includes("Tied");
  }

  function checkMatchStatus(ballsRemaining) {
    const status = document.getElementById("status");
    const t1 = document.getElementById("team1").value || "Team 1";
    const t2 = document.getElementById("team2").value || "Team 2";

    status.textContent = ""; 

    if (isSecondInnings) {
      setControlsDisabled(false); 
      if (runs > target) {
        status.textContent = `üéâ ${t2} won the match!`;
        status.style.color = "#4caf50";
        setControlsDisabled(true); 
        createConfetti();
      } else if (wickets >= 10 || ballsRemaining <= 0) {
        setControlsDisabled(true); 
        if (runs === target) {
          status.textContent = "ü§ù Match Tied!";
          status.style.color = "#ffeb3b";
        } else {
          status.textContent = `üíî ${t1} won the match!`;
          status.style.color = "#f44336";
        }
      }
    } else {
      document.getElementById("inningsBtn").disabled = true;
      if (wickets >= 10 || (overs * 6 + balls) >= totalBalls) {
        document.getElementById("inningsBtn").disabled = false;
        status.textContent = "1st Innings Over. Click to Start 2nd Innings.";
        status.style.color = "#4cc9f0";
        setControlsDisabled(true); 
      } else {
        setControlsDisabled(false); 
      }
    }
  }

  function switchInnings() {
    firstInningsRuns = runs;
    target = runs + 1;
    
    // Reset score and state for 2nd innings
    runs = wickets = overs = balls = 0;
    isSecondInnings = true;
    currentOverBalls = [];
    overHistory = [];
    history = []; // Clear history for the new innings

    document.getElementById("status").textContent = "";
    document.getElementById("inningsBtn").style.display = "none";
    setControlsDisabled(false); 
    updateDisplay();
  }

  function reset() {
    runs = wickets = overs = balls = 0;
    isSecondInnings = false;
    target = 0;
    firstInningsRuns = 0;
    currentOverBalls = [];
    overHistory = [];
    history = []; // Clear history on full reset

    document.getElementById("inningsBtn").style.display = "block";
    document.getElementById("inningsBtn").disabled = true;
    document.getElementById("status").textContent = "";
    document.getElementById("targetBox").style.display = "none";
    document.getElementById("overSummary").innerHTML = "";
    setControlsDisabled(false); 
    updateDisplay();
  }
</script>
</body>
</html>
